<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Classifica Totale - MusicLeague</title>

  <!-- Deve esistere nella root docs/ -->
  <link rel="stylesheet" href="styles.css?v=2" />
</head>

<body>
  <div class="bg"></div>

  <div class="wrap">

    <div class="card headerHero">
      <div class="navPills">
        <a class="navPill" href="index.html">üè† Home</a>
        <a class="navPill" href="months.html">üóìÔ∏è Mesi</a>
      </div>

      <div class="headerTitleRow" style="justify-content:center;">
        <div class="headerAppIcon"><span>üìä</span></div>
        <h1 class="headerTitle">Classifica Totale</h1>
      </div>

      <p class="headerSub" style="text-align:center;">
        Giocatori: da <b>data/totali/classifica_utenti.csv</b> ‚Ä¢ Canzoni: da <b>data/totali/classifica_canzoni.csv</b>
      </p>
    </div>

    <!-- ‚úÖ GIOCATORI (in cima) -->
    <div class="card card-users">
      <h2 style="margin-top:0">üë§ GIOCATORI</h2>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 12px 0;">
        <button class="btn" id="playersFullscreenBtn" type="button">üîç Schermo intero</button>
        <button class="btn" id="playersDetailBtn" type="button">üßæ Dettaglio mesi</button>
      </div>

      <div id="playersWrap" class="tableWrap">
        <table id="playersTable">
          <thead>
            <tr>
              <th data-key="rank">Rank</th>
              <th data-key="player">Utente</th>
              <th data-key="totale_media">Media Totale</th>
              <th data-key="totale_punti">Punti Totali</th>
            </tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>

      <p id="playersStatus" class="hint" style="margin-top:10px;"></p>
    </div>

    <!-- ‚úÖ CANZONI (da file tuo, senza dettaglio mesi) -->
    <div class="card">
      <h2 style="margin-top:0">üéµ CANZONI</h2>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 12px 0;">
        <button class="btn" id="songsFullscreenBtn" type="button">üîç Schermo intero</button>
      </div>

      <div id="songsWrap" class="tableWrap">
        <table id="songsTable">
          <thead>
            <tr>
              <th data-key="rank">Rank</th>
              <th data-key="title">Titolo</th>
              <th data-key="artist">Artista/Band</th>
              <th data-key="avgTotal">Media Totale</th>
              <th data-key="pointsTotal">Punti Totali</th>
              <th data-key="user">Utente</th>
            </tr>
          </thead>
          <tbody id="songsBody"></tbody>
        </table>
      </div>

      <p id="songsStatus" class="hint" style="margin-top:10px;"></p>
    </div>

  </div>

  <!-- Overlay unico -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-title" id="overlayTitle">Dettaglio</div>
        <button class="btn" id="closeOverlayBtn" type="button">‚úñ Chiudi</button>
      </div>
      <div class="overlay-body" id="overlayBody"></div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG (file totali)
    // =========================
    const PLAYERS_TOTALS_CSV = "data/totali/classifica_utenti.csv";
    const SONGS_TOTALS_CSV   = "data/totali/classifica_canzoni.csv";

    // =========================
    // Helpers
    // =========================
    function escapeHtml(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, m =>
        ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])
      );
    }

    function cleanCell(x) {
      return (x ?? "").toString().trim();
    }

    function toNumberIT(x) {
      const s = cleanCell(x).replace(",", ".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function toIntIT(x) {
      const s = cleanCell(x).replace(",", ".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function splitLineSemi(line) {
      return line.split(";");
    }

    function normalizeHeader(h) {
      return cleanCell(h).toLowerCase()
        .replace(/\s+/g, "_")
        .replace(/[^\w√†√®√©√¨√≤√π_-]/g, "");
    }

    function rankBadgeHtml(rankNumber) {
      const n = parseInt(rankNumber, 10);
      let cls = "rankBadge";
      if (n === 1) cls += " rankGold";
      else if (n === 2) cls += " rankSilver";
      else if (n === 3) cls += " rankBronze";
      return `<span class="${cls}">${escapeHtml(rankNumber)}</span>`;
    }

    async function fetchText(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Impossibile leggere: ${url} (HTTP ${res.status})`);
      return await res.text();
    }

    // =========================
    // Overlay
    // =========================
    const overlay = document.getElementById("overlay");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlayBody = document.getElementById("overlayBody");
    document.getElementById("closeOverlayBtn").addEventListener("click", closeOverlay);
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeOverlay(); });

    function openOverlay(title, html, fullscreen = false) {
      overlayTitle.textContent = title;
      overlayBody.innerHTML = html;
      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      if (fullscreen) {
        const wrap = overlayBody.querySelector(".tableWrap");
        if (wrap) wrap.classList.add("fullscreenMode");
      }
    }

    function closeOverlay() {
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      overlayBody.innerHTML = "";
    }

    // =========================
    // Load PLAYERS (totali + mesi per dettaglio)
    // =========================
    async function loadPlayersFromTotalsCsv() {
      const text = await fetchText(PLAYERS_TOTALS_CSV);
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) return { players: [], monthNames: [] };

      const headerRaw  = splitLineSemi(lines[0]).map(cleanCell);
      const headerNorm = headerRaw.map(normalizeHeader);

      const idxUtente   = headerNorm.indexOf("utente");
      const idxTotPunti = headerNorm.indexOf("totale_punti");
      const idxTotMedia = headerNorm.indexOf("totale_media");

      if (idxUtente === -1 || idxTotPunti === -1 || idxTotMedia === -1) {
        throw new Error("Header utenti non valido: servono Utente, Totale_punti, Totale_media");
      }

      // mesi dal header: Gennaio_punti / Gennaio_media ...
      const monthNames = [];
      const monthCols = [];
      for (let i=0; i<headerNorm.length; i++) {
        const h = headerNorm[i];
        if (h.endsWith("_punti") && !h.startsWith("totale_")) {
          const base = h.replace("_punti", "");
          const idxMedia = headerNorm.indexOf(base + "_media");
          if (idxMedia !== -1) {
            const pretty = headerRaw[i].replace(/_punti/i, "").trim();
            monthNames.push(pretty || base);
            monthCols.push({ name: (pretty || base), puntiIdx: i, mediaIdx: idxMedia });
          }
        }
      }

      const rows = lines.slice(1).map(l => splitLineSemi(l).map(cleanCell));

      const players = rows
        .filter(cols => cols[idxUtente] && cols[idxUtente].trim() !== "")
        .map(cols => {
          const months = monthCols.map(m => ({
            name: m.name,
            punti: toIntIT(cols[m.puntiIdx]),
            media: toNumberIT(cols[m.mediaIdx])
          }));

          return {
            // Rank lo ricalcoliamo sempre in UI (ordinamento dinamico)
            player: cols[idxUtente],
            totale_punti: toIntIT(cols[idxTotPunti]),
            totale_media: toNumberIT(cols[idxTotMedia]),
            months
          };
        });

      // default sort: punti desc
      players.sort((a,b) => b.totale_punti - a.totale_punti);
      return { players, monthNames };
    }

    // =========================
    // Load SONGS (solo totali, niente mesi)
    // =========================
    function findFirstIndex(headerNorm, candidates) {
      for (const c of candidates) {
        const idx = headerNorm.indexOf(c);
        if (idx !== -1) return idx;
      }
      return -1;
    }

    async function loadSongsFromTotalsCsv() {
      const text = await fetchText(SONGS_TOTALS_CSV);
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) return [];

      const headerRaw  = splitLineSemi(lines[0]).map(cleanCell);
      const headerNorm = headerRaw.map(normalizeHeader);

      // accettiamo varianti di header
      const idxRank  = findFirstIndex(headerNorm, ["rank", "pos", "posizione"]);
      const idxTitle = findFirstIndex(headerNorm, ["titolo", "title"]);
      const idxArt   = findFirstIndex(headerNorm, ["artista", "artist", "artista_band", "artistaband"]);
      const idxAvg   = findFirstIndex(headerNorm, ["media", "media_totale", "avg", "average"]);
      const idxPts   = findFirstIndex(headerNorm, ["punti", "punti_totali", "points", "points_total"]);
      const idxUser  = findFirstIndex(headerNorm, ["utente", "proponente", "user"]);

      if (idxTitle === -1 || idxArt === -1 || idxAvg === -1 || idxPts === -1 || idxUser === -1) {
        throw new Error("Header canzoni non valido: servono Titolo, Artista, Media, Punti, Utente (Rank opzionale)");
      }

      const rows = lines.slice(1).map(l => splitLineSemi(l).map(cleanCell));

      const songs = rows
        .filter(cols => cols[idxTitle] && cols[idxTitle].trim() !== "")
        .map(cols => ({
          rank: idxRank !== -1 ? cleanCell(cols[idxRank]) : "",
          title: cleanCell(cols[idxTitle]),
          artist: cleanCell(cols[idxArt]),
          avgTotal: toNumberIT(cols[idxAvg]),
          pointsTotal: toIntIT(cols[idxPts]),
          user: cleanCell(cols[idxUser])
        }));

      // default sort: punti desc (se vuoi rank fisso da file, dimmelo e lo rispettiamo)
      songs.sort((a,b) => b.pointsTotal - a.pointsTotal);
      return songs;
    }

    // =========================
    // Render
    // =========================
    function renderPlayersTable(items) {
      const body = document.getElementById("playersBody");
      body.innerHTML = items.map((it, i) => `
        <tr>
          <td>${rankBadgeHtml(i+1)}</td>
          <td>${escapeHtml(it.player)}</td>
          <td>${it.totale_media.toFixed(2).replace(".", ",")}</td>
          <td class="points">${escapeHtml(it.totale_punti)}</td>
        </tr>
      `).join("");
    }

    function renderSongsTable(items) {
      const body = document.getElementById("songsBody");
      body.innerHTML = items.map((it, i) => `
        <tr>
          <td>${rankBadgeHtml(i+1)}</td>
          <td>${escapeHtml(it.title)}</td>
          <td style="color:var(--muted);">${escapeHtml(it.artist)}</td>
          <td>${it.avgTotal.toFixed(2).replace(".", ",")}</td>
          <td class="points">${escapeHtml(it.pointsTotal)}</td>
          <td style="color:var(--muted);">${escapeHtml(it.user)}</td>
        </tr>
      `).join("");
    }

    // =========================
    // Dettaglio mesi (solo giocatori)
    // =========================
    function renderPlayersDetailTable(items, monthNames) {
      const cols = monthNames.flatMap(m => [`${m} Punti`, `${m} Media`]);

      const head = `
        <tr>
          <th>Rank</th>
          <th>Utente</th>
          ${cols.map(c => `<th>${escapeHtml(c)}</th>`).join("")}
          <th>Totale Punti</th>
          <th>Totale Media</th>
        </tr>
      `;

      const rows = items.map((it, i) => {
        const monthCells = (it.months || []).flatMap(x => ([
          `<td class="points">${escapeHtml(x.punti)}</td>`,
          `<td>${escapeHtml(x.media ? x.media.toFixed(2).replace(".", ",") : "")}</td>`
        ])).join("");

        return `
          <tr>
            <td>${rankBadgeHtml(i+1)}</td>
            <td>${escapeHtml(it.player)}</td>
            ${monthCells}
            <td class="points">${escapeHtml(it.totale_punti)}</td>
            <td>${it.totale_media.toFixed(2).replace(".", ",")}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="tableWrap fullscreenMode">
          <table>
            <thead>${head}</thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    // =========================
    // Ordinamento cliccando intestazioni
    // =========================
    function makeSortable(tableEl, getDataFn, renderFn) {
      const state = { key: null, dir: "desc" };

      tableEl.querySelectorAll("th[data-key]").forEach(th => {
        const key = th.getAttribute("data-key");
        if (key === "rank") return;

        th.style.cursor = "pointer";
        th.addEventListener("click", () => {
          const data = getDataFn();

          if (state.key === key) state.dir = (state.dir === "desc" ? "asc" : "desc");
          else { state.key = key; state.dir = "desc"; }

          const mul = state.dir === "desc" ? -1 : 1;

          data.sort((a,b) => {
            const va = a[key];
            const vb = b[key];

            if (typeof va === "number" && typeof vb === "number") return (va - vb) * mul;
            return (va ?? "").toString().localeCompare((vb ?? "").toString(), "it", { sensitivity:"base" }) * mul;
          });

          renderFn(data);
        });
      });
    }

    // =========================
    // Boot
    // =========================
    let PLAYERS = [];
    let PLAYERS_MONTH_NAMES = [];
    let SONGS = [];

    (async function main(){
      // PLAYERS
      const playersRes = await loadPlayersFromTotalsCsv();
      PLAYERS = playersRes.players;
      PLAYERS_MONTH_NAMES = playersRes.monthNames;

      // SONGS
      SONGS = await loadSongsFromTotalsCsv();

      // render
      renderPlayersTable([...PLAYERS]);
      renderSongsTable([...SONGS]);

      // sortable
      makeSortable(document.getElementById("playersTable"), () => [...PLAYERS], renderPlayersTable);
      makeSortable(document.getElementById("songsTable"), () => [...SONS], renderSongsTable);

      // fullscreen summary
      document.getElementById("playersFullscreenBtn").addEventListener("click", () => {
        openOverlay("üë§ Giocatori ‚Äî Schermo intero",
          `<div class="tableWrap fullscreenMode">${document.getElementById("playersWrap").innerHTML}</div>`,
          true
        );
      });

      document.getElementById("songsFullscreenBtn").addEventListener("click", () => {
        openOverlay("üéµ Canzoni ‚Äî Schermo intero",
          `<div class="tableWrap fullscreenMode">${document.getElementById("songsWrap").innerHTML}</div>`,
          true
        );
      });

      // dettaglio mesi (UNO per tabella) ‚Äî solo giocatori
      document.getElementById("playersDetailBtn").addEventListener("click", () => {
        const html = renderPlayersDetailTable([...PLAYERS], PLAYERS_MONTH_NAMES);
        openOverlay("üë§ Giocatori ‚Äî Dettaglio mesi", html, true);
      });

      // status (se vuote)
      if (!SONGS.length) document.getElementById("songsStatus").textContent =
        `Nessun dato trovato. Carica ${SONGS_TOTALS_CSV} (separato da ;)`;
      if (!PLAYERS.length) document.getElementById("playersStatus").textContent =
        `Nessun dato trovato. Carica ${PLAYERS_TOTALS_CSV} (separato da ;)`;

    })().catch(err => {
      console.error(err);
      openOverlay("Errore", `<div style="padding:14px">‚ö†Ô∏è ${escapeHtml(err.message)}</div>`, false);
    });
  </script>
</body>
</html>
