<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Classifica Totale - MusicLeague</title>

  <!-- IMPORTANTE: questo file deve ESISTERE nella root del sito (docs/styles.css) -->
  <link rel="stylesheet" href="styles.css?v=1" />
</head>

<body>
  <div class="bg"></div>

  <div class="wrap">

    <div class="card headerHero">
      <div class="navPills">
        <a class="navPill" href="index.html">üè† Home</a>
        <a class="navPill" href="months.html">üóìÔ∏è Mesi</a>
      </div>

      <div class="headerTitleRow" style="justify-content:center;">
        <div class="headerAppIcon"><span>üìä</span></div>
        <h1 class="headerTitle">Classifica Totale</h1>
      </div>

      <p class="headerSub" style="text-align:center;">
        Canzoni: somma dai mesi in <b>data/manifest.json</b> ‚Ä¢ Giocatori: da <b>data/totali/classifica_utenti.csv</b>
      </p>
    </div>

    <!-- CANZONI -->
    <div class="card">
      <h2 style="margin-top:0">üéµ Canzoni</h2>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 12px 0;">
        <button class="btn" id="songsFullscreenBtn" type="button">üîç Schermo intero</button>
        <button class="btn" id="songsDetailBtn" type="button">üßæ Dettaglio mesi</button>
      </div>

      <div id="songsWrap" class="tableWrap">
        <table id="songsTable">
          <thead>
            <tr>
              <th data-key="rank">Rank</th>
              <th data-key="title">Titolo</th>
              <th data-key="artist">Artista/Band</th>
              <th data-key="avgTotal">Media Totale</th>
              <th data-key="pointsTotal">Punti Totali</th>
              <th data-key="proponente">Proponente</th>
            </tr>
          </thead>
          <tbody id="songsBody"></tbody>
        </table>
      </div>

      <p id="songsStatus" class="hint" style="margin-top:10px;"></p>
    </div>

    <!-- GIOCATORI -->
    <div class="card card-users">
      <h2 style="margin-top:0">üë§ GIOCATORI</h2>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 12px 0;">
        <button class="btn" id="playersFullscreenBtn" type="button">üîç Schermo intero</button>
        <button class="btn" id="playersDetailBtn" type="button">üßæ Dettaglio mesi</button>
      </div>

      <div id="playersWrap" class="tableWrap">
        <table id="playersTable">
          <thead>
            <tr>
              <th data-key="rank">Rank</th>
              <th data-key="player">Utente</th>
              <th data-key="totale_media">Media Totale</th>
              <th data-key="totale_punti">Punti Totali</th>
            </tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>

      <p id="playersStatus" class="hint" style="margin-top:10px;"></p>
    </div>

  </div>

  <!-- Overlay unico -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-title" id="overlayTitle">Dettaglio</div>
        <button class="btn" id="closeOverlayBtn" type="button">‚úñ Chiudi</button>
      </div>
      <div class="overlay-body" id="overlayBody"></div>
    </div>
  </div>

  <script>
    // =========================
    // Helpers
    // =========================
    function escapeHtml(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, m =>
        ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])
      );
    }

    function toNumberIT(x) {
      const s = (x ?? "").toString().trim().replace(",", ".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function toIntIT(x) {
      const s = (x ?? "").toString().trim().replace(",", ".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function splitLine(line) {
      // robusto (usa per top10)
      if (line.includes(";")) return line.split(";");
      if (line.includes("\t")) return line.split("\t");
      return line.split(",");
    }

    function splitLineSemi(line) {
      // FORZATO per classifica_utenti.csv
      return line.split(";");
    }

    function cleanCell(x) {
      return (x ?? "").toString().trim();
    }

    function rankBadgeHtml(rankNumber) {
      const n = parseInt(rankNumber, 10);
      let cls = "rankBadge";
      if (n === 1) cls += " rankGold";
      else if (n === 2) cls += " rankSilver";
      else if (n === 3) cls += " rankBronze";
      return `<span class="${cls}">${escapeHtml(rankNumber)}</span>`;
    }

    async function fetchText(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Impossibile leggere: ${url} (HTTP ${res.status})`);
      return await res.text();
    }

    // =========================
    // Overlay
    // =========================
    const overlay = document.getElementById("overlay");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlayBody = document.getElementById("overlayBody");
    document.getElementById("closeOverlayBtn").addEventListener("click", closeOverlay);
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeOverlay(); });

    function openOverlay(title, html, fullscreen = false) {
      overlayTitle.textContent = title;
      overlayBody.innerHTML = html;
      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      if (fullscreen) {
        const wrap = overlayBody.querySelector(".tableWrap");
        if (wrap) wrap.classList.add("fullscreenMode");
      }
    }

    function closeOverlay() {
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      overlayBody.innerHTML = "";
    }

    // =========================
    // Manifest + Songs dai mesi
    // =========================
    async function loadManifest() {
      const text = await fetchText("data/manifest.json");
      return JSON.parse(text);
    }

    async function loadMonthSongs(monthId) {
      const text = await fetchText(`data/${monthId}/top10.csv`);
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      const rows = lines.slice(1).map(splitLine);

      return rows.map(cols => ({
        monthId,
        title: cleanCell(cols[1]),
        artist: cleanCell(cols[2]),
        avg: toNumberIT(cols[3]),
        points: toIntIT(cols[4]),
        proponente: cleanCell(cols[5])
      }));
    }

    function aggregateSongs(allRows) {
      const map = new Map();
      for (const r of allRows) {
        const key = `${r.title}||${r.artist}||${r.proponente}`;
        if (!map.has(key)) {
          map.set(key, {
            key,
            title: r.title,
            artist: r.artist,
            proponente: r.proponente,
            pointsTotal: 0,
            avgWeightedSum: 0,
            weight: 0,
            byMonth: new Map() // monthId -> {points, avg}
          });
        }
        const o = map.get(key);
        o.pointsTotal += r.points;
        o.avgWeightedSum += (r.avg * r.points);
        o.weight += r.points;
        o.byMonth.set(r.monthId, { points: r.points, avg: r.avg });
      }

      const list = Array.from(map.values()).map(o => ({
        ...o,
        avgTotal: o.weight > 0 ? (o.avgWeightedSum / o.weight) : 0
      }));

      list.sort((a,b) => b.pointsTotal - a.pointsTotal);
      return list;
    }

    // =========================
    // Players da CSV totali
    // =========================
    function normalizeHeader(h) {
      return cleanCell(h).toLowerCase()
        .replace(/\s+/g, "_")
        .replace(/[^\w√†√®√©√¨√≤√π_-]/g, "");
    }

    async function loadPlayersFromTotalsCsv() {
      const text = await fetchText("data/totali/classifica_utenti.csv");
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");

      if (lines.length < 2) return { players: [], monthNames: [] };

      // header FORZATO su ;
      const headerRaw = splitLineSemi(lines[0]).map(cleanCell);
      const headerNorm = headerRaw.map(normalizeHeader);

      // trova colonne totali
      const idxUtente = headerNorm.indexOf("utente");
      const idxTotPunti = headerNorm.indexOf("totale_punti");
      const idxTotMedia = headerNorm.indexOf("totale_media");

      if (idxUtente === -1 || idxTotPunti === -1 || idxTotMedia === -1) {
        throw new Error("Header CSV utenti non valido: servono Utente, Totale_punti, Totale_media");
      }

      // individua mesi dall‚Äôheader nell‚Äôordine del file
      // es: Gennaio_punti, Gennaio_media...
      const monthNames = [];
      const monthCols = []; // {name, puntiIdx, mediaIdx}

      for (let i=0; i<headerNorm.length; i++) {
        const h = headerNorm[i];
        if (h.endsWith("_punti") && !h.startsWith("totale_")) {
          const base = h.replace("_punti", "");
          const idxMedia = headerNorm.indexOf(base + "_media");
          if (idxMedia !== -1) {
            const pretty = headerRaw[i].replace(/_punti/i, "").trim();
            monthNames.push(pretty || base);
            monthCols.push({ name: (pretty || base), puntiIdx: i, mediaIdx: idxMedia });
          }
        }
      }

      const rows = lines.slice(1).map(l => splitLineSemi(l).map(cleanCell));

      const players = rows
        .filter(cols => cols[idxUtente] && cols[idxUtente].trim() !== "")
        .map(cols => {
          const months = monthCols.map(m => ({
            name: m.name,
            punti: toIntIT(cols[m.puntiIdx]),
            media: toNumberIT(cols[m.mediaIdx])
          }));

          return {
            player: cols[idxUtente],
            totale_punti: toIntIT(cols[idxTotPunti]),
            totale_media: toNumberIT(cols[idxTotMedia]),
            months
          };
        });

      // default sort: totale_punti desc
      players.sort((a,b) => b.totale_punti - a.totale_punti);
      return { players, monthNames };
    }

    // =========================
    // Render (SUMMARY)
    // =========================
    function renderSongsTable(items) {
      const body = document.getElementById("songsBody");
      body.innerHTML = items.map((it, i) => `
        <tr>
          <td>${rankBadgeHtml(i+1)}</td>
          <td>${escapeHtml(it.title)}</td>
          <td style="color:var(--muted);">${escapeHtml(it.artist)}</td>
          <td>${it.avgTotal.toFixed(2).replace(".", ",")}</td>
          <td class="points">${escapeHtml(it.pointsTotal)}</td>
          <td style="color:var(--muted);">${escapeHtml(it.proponente)}</td>
        </tr>
      `).join("");
    }

    function renderPlayersTable(items) {
      const body = document.getElementById("playersBody");
      body.innerHTML = items.map((it, i) => `
        <tr>
          <td>${rankBadgeHtml(i+1)}</td>
          <td>${escapeHtml(it.player)}</td>
          <td>${it.totale_media.toFixed(2).replace(".", ",")}</td>
          <td class="points">${escapeHtml(it.totale_punti)}</td>
        </tr>
      `).join("");
    }

    // =========================
    // Render (DETTAGLIO MESI)
    // =========================
    function renderPlayersDetailTable(items, monthNames) {
      const cols = monthNames.flatMap(m => [`${m} Punti`, `${m} Media`]);
      const head = `
        <tr>
          <th data-key="rank">Rank</th>
          <th data-key="player">Utente</th>
          ${cols.map(c => `<th>${escapeHtml(c)}</th>`).join("")}
          <th data-key="totale_punti">Totale Punti</th>
          <th data-key="totale_media">Totale Media</th>
        </tr>
      `;

      const rows = items.map((it, i) => {
        const monthCells = (it.months || []).flatMap(x => ([
          `<td class="points">${escapeHtml(x.punti)}</td>`,
          `<td>${escapeHtml(x.media ? x.media.toFixed(2).replace(".", ",") : "")}</td>`
        ])).join("");

        return `
          <tr>
            <td>${rankBadgeHtml(i+1)}</td>
            <td>${escapeHtml(it.player)}</td>
            ${monthCells}
            <td class="points">${escapeHtml(it.totale_punti)}</td>
            <td>${it.totale_media.toFixed(2).replace(".", ",")}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="tableWrap fullscreenMode">
          <table>
            <thead>${head}</thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function renderSongsDetailTable(items, manifestMonths) {
      // colonne mesi = (label Punti, label Media) per ogni mese
      const cols = manifestMonths.flatMap(m => [`${m.label} Punti`, `${m.label} Media`]);

      const head = `
        <tr>
          <th data-key="rank">Rank</th>
          <th data-key="title">Titolo</th>
          <th data-key="artist">Artista/Band</th>
          <th data-key="proponente">Proponente</th>
          ${cols.map(c => `<th>${escapeHtml(c)}</th>`).join("")}
          <th data-key="pointsTotal">Totale Punti</th>
          <th data-key="avgTotal">Media Totale</th>
        </tr>
      `;

      const rows = items.map((it, i) => {
        const monthCells = manifestMonths.flatMap(m => {
          const bm = it.byMonth.get(m.id);
          const punti = bm ? bm.points : "";
          const media = bm ? bm.avg : "";
          return [
            `<td class="points">${escapeHtml(punti)}</td>`,
            `<td>${escapeHtml(media !== "" ? Number(media).toFixed(2).replace(".", ",") : "")}</td>`
          ];
        }).join("");

        return `
          <tr>
            <td>${rankBadgeHtml(i+1)}</td>
            <td>${escapeHtml(it.title)}</td>
            <td style="color:var(--muted);">${escapeHtml(it.artist)}</td>
            <td style="color:var(--muted);">${escapeHtml(it.proponente)}</td>
            ${monthCells}
            <td class="points">${escapeHtml(it.pointsTotal)}</td>
            <td>${it.avgTotal.toFixed(2).replace(".", ",")}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="tableWrap fullscreenMode">
          <table>
            <thead>${head}</thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    // =========================
    // Ordinamento (summary)
    // =========================
    function makeSortable(tableEl, getDataFn, renderFn) {
      const state = { key: null, dir: "desc" };

      tableEl.querySelectorAll("th[data-key]").forEach(th => {
        const key = th.getAttribute("data-key");
        if (key === "rank") return;

        th.style.cursor = "pointer";
        th.addEventListener("click", () => {
          const data = getDataFn();

          if (state.key === key) state.dir = (state.dir === "desc" ? "asc" : "desc");
          else { state.key = key; state.dir = "desc"; }

          const mul = state.dir === "desc" ? -1 : 1;

          data.sort((a,b) => {
            const va = a[key];
            const vb = b[key];

            if (typeof va === "number" && typeof vb === "number") return (va - vb) * mul;
            return (va ?? "").toString().localeCompare((vb ?? "").toString(), "it", { sensitivity:"base" }) * mul;
          });

          renderFn(data);
        });
      });
    }

    // =========================
    // Boot
    // =========================
    let SONGS = [];
    let PLAYERS = [];
    let MANIFEST_MONTHS = [];
    let PLAYERS_MONTH_NAMES = [];

    (async function main(){
      // manifest
      const manifest = await loadManifest();
      MANIFEST_MONTHS = (manifest.months || []);

      // SONGS: somma dai mesi
      let allSongRows = [];
      for (const m of MANIFEST_MONTHS) {
        const rows = await loadMonthSongs(m.id);
        allSongRows = allSongRows.concat(rows);
      }
      SONGS = aggregateSongs(allSongRows);

      // PLAYERS: da file totali
      const playersRes = await loadPlayersFromTotalsCsv();
      PLAYERS = playersRes.players;
      PLAYERS_MONTH_NAMES = playersRes.monthNames;

      renderSongsTable([...SONGS]);
      renderPlayersTable([...PLAYERS]);

      // sortable summary
      makeSortable(document.getElementById("songsTable"), () => [...SONGS], renderSongsTable);
      makeSortable(document.getElementById("playersTable"), () => [...PLAYERS], renderPlayersTable);

      // fullscreen summary
      document.getElementById("songsFullscreenBtn").addEventListener("click", () => {
        openOverlay("üéµ Canzoni ‚Äî Schermo intero",
          `<div class="tableWrap fullscreenMode">${document.getElementById("songsWrap").innerHTML}</div>`,
          true
        );
      });

      document.getElementById("playersFullscreenBtn").addEventListener("click", () => {
        openOverlay("üë§ Giocatori ‚Äî Schermo intero",
          `<div class="tableWrap fullscreenMode">${document.getElementById("playersWrap").innerHTML}</div>`,
          true
        );
      });

      // dettaglio mesi (UNO per tabella)
      document.getElementById("playersDetailBtn").addEventListener("click", () => {
        const html = renderPlayersDetailTable([...PLAYERS], PLAYERS_MONTH_NAMES);
        openOverlay("üë§ Giocatori ‚Äî Dettaglio mesi", html, true);
      });

      document.getElementById("songsDetailBtn").addEventListener("click", () => {
        const html = renderSongsDetailTable([...SONGS], MANIFEST_MONTHS);
        openOverlay("üéµ Canzoni ‚Äî Dettaglio mesi", html, true);
      });

    })().catch(err => {
      console.error(err);
      openOverlay("Errore", `<div style="padding:14px">‚ö†Ô∏è ${escapeHtml(err.message)}</div>`, false);
    });
  </script>
</body>
</html>
